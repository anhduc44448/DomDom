<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <title>Gi·ªè h√†ng - ƒêom ƒë√≥m qu√°n</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="css/cart.css">
  <style>
    .order-processing {
      text-align: center;
      padding: 30px;
    }

    .order-success {
      text-align: center;
      padding: 30px;
      color: #28a745;
    }
  </style>
</head>

<body>
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="index.html">
        <img src="logo.png" alt="ƒêom ƒë√≥m qu√°n" width="150">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ms-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Trang ch·ªß</a></li>
          <li class="nav-item"><a class="nav-link" href="about.html">Gi·ªõi thi·ªáu</a></li>
          <li class="nav-item"><a class="nav-link" href="menu.html">Th·ª±c ƒë∆°n</a></li>
          <li class="nav-item"><a class="nav-link" href="contact.html">Li√™n h·ªá</a></li>
          <li class="nav-item"><a class="nav-link active" href="cart.html">üõí Gi·ªè h√†ng <span id="cartCount"
                class="badge bg-danger">0</span></a></li>
        </ul>
      </div>
    </div>
  </nav>

  <button id="loginBtn" class="btn btn-primary">ƒêƒÉng nh·∫≠p</button>

  <div class="cart-container">
    <div class="container">
      <h1 class="cart-title">Gi·ªè H√†ng</h1>

      <div id="cartContent">
        <!-- Cart s·∫Ω ƒë∆∞·ª£c render b·∫±ng JavaScript -->
        <div id="cartList" class="cart-list"></div>
        <div id="emptyCart" class="empty-cart text-center" style="display: none;">
          <div class="empty-icon">üõí</div>
          <h3>Gi·ªè h√†ng tr·ªëng</h3>
          <p>H√£y th√™m m√≥n ngon v√†o gi·ªè h√†ng c·ªßa b·∫°n!</p>
          <a href="menu.html" class="btn btn-order">Kh√°m ph√° th·ª±c ƒë∆°n</a>
        </div>
      </div>

      <!-- Customer Info Form -->
      <div id="customerForm" class="customer-info" style="display: none;">
        <h4>Th√¥ng tin kh√°ch h√†ng</h4>
        <form id="customerInfoForm">
          <div class="row">
            <div class="col-md-6">
              <div class="form-group">
                <label for="customerName">H·ªç v√† t√™n *</label>
                <input type="text" id="customerName" class="form-control" required>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-group">
                <label for="customerTable">S·ªë b√†n *</label>
                <select id="customerTable" class="form-control" required>
                  <option value="">Ch·ªçn s·ªë b√†n</option>
                  <option value="1">B√†n 1</option>
                  <option value="2">B√†n 2</option>
                  <option value="3">B√†n 3</option>
                  <option value="4">B√†n 4</option>
                  <option value="5">B√†n 5</option>
                  <option value="6">B√†n 6</option>
                  <option value="VIP-1">B√†n VIP 1</option>
                  <option value="VIP-2">B√†n VIP 2</option>
                </select>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label for="customerNote">Ghi ch√∫ (n·∫øu c√≥)</label>
            <textarea id="customerNote" class="form-control" rows="3"
              placeholder="V√≠ d·ª•: √çt ƒë∆∞·ªùng, √≠t ƒë√°, kh√¥ng h√†nh..."></textarea>
          </div>
        </form>
      </div>

      <!-- Order Summary -->
      <div id="orderSummary" class="cart-summary" style="display: none;">
        <div class="row align-items-center">
          <div class="col-md-6">
            <div class="total-section">
              <h4>T·ªïng c·ªông:</h4>
              <div id="totalAmount" class="total-amount">0ƒë</div>
            </div>
          </div>
          <div class="col-md-6 text-end">
            <button id="submitOrderBtn" class="btn btn-order btn-lg">ƒê·∫∑t h√†ng ngay</button>
            <a href="menu.html" class="btn btn-secondary btn-lg ms-2">Th√™m m√≥n</a>
          </div>
        </div>
      </div>
    </div>
  </div>

  <footer>
    <p>&copy; 2024 ƒêom ƒë√≥m qu√°n</p>
  </footer>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let cart = [];

    async function loadCart() {
      cart = JSON.parse(localStorage.getItem('cart')) || [];
      renderCart();
      updateCartCount();
    }

    function renderCart() {
      const cartList = document.getElementById('cartList');
      const emptyCart = document.getElementById('emptyCart');
      const customerForm = document.getElementById('customerForm');
      const orderSummary = document.getElementById('orderSummary');

      if (cart.length === 0) {
        cartList.innerHTML = '';
        cartList.style.display = 'none';
        customerForm.style.display = 'none';
        orderSummary.style.display = 'none';
        emptyCart.style.display = 'block';
        return;
      }

      let html = '';
      let total = 0;

      cart.forEach((item, index) => {
        const itemTotal = item.price * item.quantity;
        total += itemTotal;

        html += `
                    <div class="cart-item">
                        <img src="${item.img}" alt="${item.name}" 
                             onerror="this.src='database/AnhDoAn/BanhTranBo.jpg'">
                        <div class="cart-details">
                            <h5>${item.name}</h5>
                            <div class="cart-info">K√≠ch c·ª°: <b>${getSizeName(item.size)}</b></div>
                            <div class="cart-info">S·ªë l∆∞·ª£ng: <b>${item.quantity}</b></div>
                            <div class="cart-price">${formatPrice(itemTotal)}ƒë</div>
                            <div class="quantity-controls">
                                <button class="quantity-btn" onclick="updateQuantity(${index}, -1)">-</button>
                                <span class="quantity">${item.quantity}</span>
                                <button class="quantity-btn" onclick="updateQuantity(${index}, 1)">+</button>
                            </div>
                        </div>
                        <button class="btn-remove" onclick="removeItem(${index})">X√≥a</button>
                    </div>
                `;
      });

      cartList.innerHTML = html;
      cartList.style.display = 'block';
      customerForm.style.display = 'block';
      orderSummary.style.display = 'block';
      emptyCart.style.display = 'none';

      document.getElementById('totalAmount').textContent = formatPrice(total) + 'ƒë';

      // Auto fill customer name if logged in
      const username = localStorage.getItem('username');
      if (username && !document.getElementById('customerName').value) {
        document.getElementById('customerName').value = username;
      }
    }

    function getSizeName(size) {
      const sizes = { S: "Nh·ªè", M: "V·ª´a", L: "L·ªõn" };
      return sizes[size] || size;
    }

    function formatPrice(price) {
      return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function updateQuantity(index, change) {
      cart[index].quantity += change;

      if (cart[index].quantity < 1) {
        cart[index].quantity = 1;
      }

      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
      updateCartCount();
    }

    function removeItem(index) {
      if (confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a s·∫£n ph·∫©m n√†y kh·ªèi gi·ªè h√†ng?")) {
        cart.splice(index, 1);
        localStorage.setItem('cart', JSON.stringify(cart));
        renderCart();
        updateCartCount();
      }
    }

    function updateCartCount() {
      const cartCount = document.getElementById('cartCount');
      if (cartCount) {
        cartCount.textContent = cart.length;
      }
    }

    async function submitOrder() {
      // Validate form
      const customerName = document.getElementById('customerName').value.trim();
      const customerTable = document.getElementById('customerTable').value.trim();

      if (!customerName) {
        alert('Vui l√≤ng nh·∫≠p h·ªç v√† t√™n');
        document.getElementById('customerName').focus();
        return;
      }

      if (!customerTable) {
        alert('Vui l√≤ng ch·ªçn s·ªë b√†n');
        document.getElementById('customerTable').focus();
        return;
      }

      // Check login
      const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
      if (!isLoggedIn) {
        alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ ƒë·∫∑t h√†ng!');
        window.location.href = 'login.php';
        return;
      }

      const userId = localStorage.getItem('user_id');
      const customerNote = document.getElementById('customerNote').value.trim();

      // Prepare order data
      const orderData = {
        user_id: userId,
        customer_name: customerName,
        table_number: customerTable,
        customer_note: customerNote,
        items: cart.map(item => ({
          product_name: item.name,
          quantity: item.quantity,
          size: item.size,
          unit_price: item.price,
          total_price: item.price * item.quantity
        })),
        total_amount: calculateTotal()
      };

      // Show loading
      const submitBtn = document.getElementById('submitOrderBtn');
      const originalText = submitBtn.textContent;
      submitBtn.textContent = 'ƒêang x·ª≠ l√Ω...';
      submitBtn.disabled = true;

      try {
        const response = await fetch('api/create_order.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(orderData)
        });

        const result = await response.json();

        if (result.success) {
          // Clear cart
          localStorage.removeItem('cart');
          cart = [];

          // Show success message
          document.getElementById('cartContent').innerHTML = `
                        <div class="order-success">
                            <div style="font-size: 80px;">‚úÖ</div>
                            <h3>ƒê·∫∑t h√†ng th√†nh c√¥ng!</h3>
                            <p>M√£ ƒë∆°n h√†ng: <strong>#${result.order_id}</strong></p>
                            <p>Nh√¢n vi√™n s·∫Ω ph·ª•c v·ª• t·∫°i b√†n ${customerTable}</p>
                            <div class="mt-4">
                                <a href="index.html" class="btn btn-order">V·ªÅ trang ch·ªß</a>
                                <a href="menu.html" class="btn btn-secondary">ƒê·∫∑t th√™m m√≥n</a>
                            </div>
                        </div>
                    `;

          document.getElementById('customerForm').style.display = 'none';
          document.getElementById('orderSummary').style.display = 'none';

        } else {
          throw new Error(result.message || 'L·ªói t·∫°o ƒë∆°n h√†ng');
        }

      } catch (error) {
        alert('L·ªói: ' + error.message);
        submitBtn.textContent = originalText;
        submitBtn.disabled = false;
      }
    }

    function calculateTotal() {
      return cart.reduce((total, item) => total + (item.price * item.quantity), 0);
    }

    // Login button functions
    function updateLoginButton() {
      const username = localStorage.getItem('username');
      const loginBtn = document.getElementById('loginBtn');

      if (!loginBtn) return;

      if (username) {
        loginBtn.textContent = `üëã ${username} | ƒêƒÉng xu·∫•t`;
        loginBtn.classList.remove('btn-primary');
        loginBtn.classList.add('btn-danger');
      } else {
        loginBtn.textContent = 'ƒêƒÉng nh·∫≠p';
        loginBtn.classList.remove('btn-danger');
        loginBtn.classList.add('btn-primary');
      }
    }

    function handleLoginClick() {
      const username = localStorage.getItem('username');

      if (username) {
        if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën ƒëƒÉng xu·∫•t kh√¥ng?')) {
          localStorage.removeItem('username');
          localStorage.removeItem('isLoggedIn');
          localStorage.removeItem('user_id');
          localStorage.removeItem('user_role');
          alert('ƒê√£ ƒëƒÉng xu·∫•t th√†nh c√¥ng!');
          updateLoginButton();
          window.location.reload();
        }
      } else {
        window.location.href = 'login.php';
      }
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', function () {
      loadCart();
      updateLoginButton();

      document.getElementById('loginBtn').addEventListener('click', handleLoginClick);
      document.getElementById('submitOrderBtn').addEventListener('click', submitOrder);
    });
  </script>
</body>

</html>